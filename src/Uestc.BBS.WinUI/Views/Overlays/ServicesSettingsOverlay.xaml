<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="Uestc.BBS.WinUI.Views.Overlays.ServicesSettingsOverlay"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:Uestc.BBS.WinUI.Views.Overlays"
    xmlns:local_converters="using:Uestc.BBS.WinUI.Converters"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:viewmodels="using:Uestc.BBS.WinUI.ViewModels"
    d:DataContext="{d:DesignInstance Type=viewmodels:ServicesSettingsViewModel}"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:StringFormatConverter x:Key="StringFormatConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <local_converters:Long2DoubleConverter x:Key="Long2DoubleConverter" />
        <local_converters:Enum2LabelConverter x:Key="Enum2LabelConverter" />
        <converters:FileSizeToFriendlyStringConverter x:Key="FileSizeToFriendlyStringConverter" />
    </Page.Resources>

    <ScrollViewer Margin="10" VerticalScrollBarVisibility="Hidden">
        <StackPanel Spacing="5">
            <!--  启动与关闭  -->
            <controls:SettingsExpander
                Description="自启动、静默启动"
                Header="启动与关闭"
                HeaderIcon="{ui:FontIcon Glyph=&#xE7B5;}">
                <controls:SettingsExpander.Items>
                    <controls:SettingsCard Description="启动后仅显示托盘图标" Header="静默启动">
                        <ToggleSwitch IsOn="{x:Bind ViewModel.ServicesSettingModel.StartupAndShutdown.SilentStart, Mode=TwoWay}" />
                    </controls:SettingsCard>
                    <controls:SettingsCard Description="效率模式可减少后台进程对 CPU 的占用（仅 Win11 支持）" Header="窗口关闭行为">
                        <ComboBox ItemsSource="{x:Bind WindowCloseBehaviors}" SelectedItem="{x:Bind ViewModel.ServicesSettingModel.StartupAndShutdown.WindowCloseBehavior, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource Enum2LabelConverter}}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </controls:SettingsCard>
                    <controls:SettingsCard Description="点击应用图标将跳转至此链接" Header="论坛跳转链接">
                        <TextBox
                            Width="260"
                            AcceptsReturn="True"
                            Text="https://bbs.uestc.edu.cn/new"
                            TextAlignment="Center" />
                    </controls:SettingsCard>
                </controls:SettingsExpander.Items>
            </controls:SettingsExpander>
            <TextBlock
                Margin="1,15,0,0"
                FontSize="14"
                Text="通用" />
            <controls:SettingsExpander
                Description="开启隐藏窗口功能时不能关闭托盘图标"
                Header="托盘图标"
                HeaderIcon="{ui:FontIcon Glyph=\&#xE945;}">
                <ToggleSwitch />
                <controls:SettingsExpander.Items>
                    <controls:SettingsCard Header="图标内容">
                        <Button Content="选择文件" />
                    </controls:SettingsCard>
                    <controls:SettingsCard Header="有新消息时闪烁">
                        <ToggleSwitch />
                    </controls:SettingsCard>
                </controls:SettingsExpander.Items>
            </controls:SettingsExpander>
            <!--  日志记录  -->
            <controls:SettingsExpander
                Description="查看应用日志或清除日志记录"
                Header="日志记录"
                HeaderIcon="{ui:FontIcon Glyph=&#xF0E3;}">
                <Button Command="{x:Bind ViewModel.OpenLogDirectoryCommand}" Content="打开文件夹" />
                <controls:SettingsExpander.Items>
                    <controls:SettingsCard Description="日志服务不会记录敏感信息" Header="启用服务">
                        <ToggleSwitch IsOn="{x:Bind ViewModel.ServicesSettingModel.Log.IsEnable, Mode=TwoWay}" />
                    </controls:SettingsCard>
                    <controls:SettingsCard
                        Description="低于此等级的日志不会输出至文件"
                        Header="记录等级"
                        IsEnabled="{x:Bind ViewModel.ServicesSettingModel.Log.IsEnable, Mode=OneWay}">
                        <ComboBox ItemsSource="{x:Bind LogLevels}" SelectedItem="{x:Bind ViewModel.ServicesSettingModel.Log.MinLevel, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource Enum2LabelConverter}}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </controls:SettingsCard>
                    <controls:SettingsCard
                        MinHeight="160"
                        Description="请参照 NLog 配置文档"
                        Header="输出格式"
                        IsEnabled="{x:Bind ViewModel.ServicesSettingModel.Log.IsEnable, Mode=OneWay}">
                        <TextBox
                            Width="300"
                            Height="120"
                            FontSize="15"
                            Text="{x:Bind ViewModel.ServicesSettingModel.Log.OutputFormat, Mode=TwoWay}"
                            TextWrapping="Wrap" />
                    </controls:SettingsCard>
                    <controls:SettingsCard
                        Description="日志达到最大尺寸后将自动创建新文件"
                        Header="存档大小"
                        IsEnabled="{x:Bind ViewModel.ServicesSettingModel.Log.IsEnable, Mode=OneWay}">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock VerticalAlignment="Center" Text="{x:Bind ViewModel.ServicesSettingModel.Log.ArchiveAboveSize, Converter={StaticResource StringFormatConverter}, ConverterParameter=' {0} MB', Mode=OneWay}" />
                            <Slider
                                Width="160"
                                Maximum="64"
                                Minimum="1"
                                Value="{x:Bind ViewModel.ServicesSettingModel.Log.ArchiveAboveSize, Converter={StaticResource Long2DoubleConverter}, Mode=TwoWay}" />
                        </StackPanel>
                    </controls:SettingsCard>
                    <controls:SettingsCard Header="存档数量" IsEnabled="{x:Bind ViewModel.ServicesSettingModel.Log.IsEnable, Mode=OneWay}">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock VerticalAlignment="Center" Text="{x:Bind ViewModel.ServicesSettingModel.Log.MaxArchiveFiles, Mode=OneWay}" />
                            <Slider
                                Width="160"
                                Maximum="32"
                                Minimum="1"
                                Value="{x:Bind ViewModel.ServicesSettingModel.Log.MaxArchiveFiles, Mode=TwoWay}" />
                        </StackPanel>
                    </controls:SettingsCard>
                    <controls:SettingsCard Header="清除日志记录">
                        <controls:SettingsCard.Description>
                            <TextBlock>
                                <Run Text="日志文件已占用 " />
                                <Run Text="{x:Bind ViewModel.LogTotalSize, Converter={StaticResource FileSizeToFriendlyStringConverter}, Mode=OneWay}" />
                            </TextBlock>
                        </controls:SettingsCard.Description>
                        <Button Command="{x:Bind ViewModel.ClearLogsCommand}" Content="全部清除" />
                    </controls:SettingsCard>
                </controls:SettingsExpander.Items>
            </controls:SettingsExpander>
            <!--  应用更新  -->
            <controls:SettingsExpander Header="应用更新" HeaderIcon="{ui:FontIcon Glyph=&#xE895;}">
                <controls:SettingsExpander.Description>
                    <StackPanel HorizontalAlignment="Left">
                        <TextBlock Text="{x:Bind ViewModel.ServicesSettingModel.Upgrade.LastCheckTime, Converter={StaticResource StringFormatConverter}, ConverterParameter='最近检查时间：{0:yyyy/MM/dd HH:mm:ss}', Mode=OneWay}" Visibility="{x:Bind ViewModel.CheckUpdateCommand.IsRunning, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True, Mode=OneWay}" />
                        <ProgressBar
                            Width="160"
                            Height="16"
                            VerticalAlignment="Center"
                            IsIndeterminate="True"
                            Visibility="{x:Bind ViewModel.CheckUpdateCommand.IsRunning, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}" />
                    </StackPanel>
                </controls:SettingsExpander.Description>
                <Button Command="{x:Bind ViewModel.CheckUpdateCommand}" Content="检查更新" />
                <controls:SettingsExpander.Items>
                    <controls:SettingsCard Description="抢先体验最新功能和改进" Header="接收预览版">
                        <ToggleSwitch IsOn="{x:Bind ViewModel.ServicesSettingModel.Upgrade.AcceptBetaVersion, Mode=TwoWay}" />
                    </controls:SettingsCard>
                    <controls:SettingsCard Header="更新镜像源">
                        <StackPanel
                            VerticalAlignment="Center"
                            Orientation="Horizontal"
                            Spacing="10">
                            <ComboBox>
                                <ComboBoxItem>Git</ComboBoxItem>
                                <ComboBoxItem>Cloudflare</ComboBoxItem>
                            </ComboBox>
                            <TextBox
                                Width="320"
                                Text="{x:Bind ViewModel.ServicesSettingModel.Upgrade.Mirror, Mode=TwoWay}"
                                TextAlignment="Center" />
                        </StackPanel>
                    </controls:SettingsCard>
                </controls:SettingsExpander.Items>
            </controls:SettingsExpander>
        </StackPanel>
    </ScrollViewer>

</Page>
